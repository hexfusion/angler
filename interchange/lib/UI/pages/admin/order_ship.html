<style type="text/css">
<!--
.style1 {color: #FFFFFF}
-->
</style>
[set page_title][L]Shipping manager[/L]: [L]View order[/L][/set]


  @_UI_STD_HEAD_@
  <!-- ----- BEGIN REAL STUFF ----- -->
  
  [if term='[cgi bypass]' op='==' compare='1'] 
  
[query  prefix=completet row_count=1 list=1 sql="SELECT * FROM ups_shipments_items_temp WHERE order_number = '[cgi order]' AND shipping_id = '[cgi shipping_id]'"][seti completet][calc ] [completet-pos 0]-0 [/calc][/seti][/query]
			 
				[query  prefix=complete row_count=1 list=1 sql="SELECT * FROM ups_shipments_items WHERE order_number = '[cgi order]' AND shipping_id = '[cgi shipping_id]'"][seti complete][calc ] [complete-pos 0]-0 [/calc][/seti][/query]
				
			 [if term='[scratch completet]' op='==' compare='0']
		
			 [if term='[scratch complete]' op='!=' compare='0']
			 

[seti order][cgi order][/seti]
[seti shipping_id][cgi shipping_id][/seti]

 [email-raw][include etc/ship_notice_new][/email-raw]  
		 
			 [query sql="UPDATE ups_shipments set ship_status = 'shipped' WHERE shipping_id ='[cgi shipping_id]'"][/query]
		<!-- more mess -->	 
			 
			 [query prefix=orderline list_prefix=orderlinelist list=1 sql="SELECT * FROM orderline WHERE order_number LIKE '[cgi order]'"]
   <!-- ok-->
    [query prefix=totalshipped list_prefix=count sql="select SUM(qty) AS 'Shipped' FROM ups_shipments_items WHERE code = '[orderline-code]'" type=list][seti shipped][calc ] [totalshipped-pos 0]-0 [/calc][/seti][/query]


	<!-- Search to see if the item exits in ups_shipment_lines  LINES-->
   			[query  prefix=shipmentlines  row_count=1 list=1 sql="SELECT * FROM ups_shipments_items WHERE code = '[orderline-code]' AND shipping_id = '[cgi shipping_id]'"][seti lines][calc][shipmentlines-param count]-0[/calc][/seti][/query]


 [if term='[scratch shipped]' op='<' compare='[calc interpolate = "1"] ([orderline-param quantity] - [scratch shipped])[/calc]']


[query sql="UPDATE orderline set status = 'partial' WHERE code='[orderline-code]'"][/query]


[/if]

[if term='[scratch shipped]' op='==' compare='[calc interpolate = "1"] ([orderline-param quantity] - [scratch shipped])[/calc]'] 

[query sql="UPDATE orderline set status = 'shipped', WHERE code='[orderline-code]'"][/query]

[/if]

[/query]

   [query prefix=totalordered sql="select SUM(qty) AS 'Ship' FROM ups_shipments_items WHERE order_number = '[cgi order]'" type=list][seti shippedtodate][calc] [totalordered-pos 0]-0 [/calc][/seti][/query]
     [query prefix=trans sql="SELECT nitems FROM transactions WHERE order_number = '[cgi order]'" type=list][seti ordered][calc ] [trans-param nitems]-0 [/calc][/seti][/query]
   
   [if term='[scratch shippedtodate]' op='==' compare='[scratch ordered]'] 
   [query sql="UPDATE transactions set status = 'shipped', complete='1', archived='1' WHERE code='[cgi order]'"][/query]
[seti ship_now_complete]1[/seti]
   [else]
[query sql="UPDATE transactions set status = 'partial', complete='2' WHERE code='[cgi order]'"][/query]
[seti ship_now_complete]0[/seti]

[/else]
   

		[/if]
		
		[/if]
		


          <div align="center">
<form action="[area __UI_BASE__/order_view_new]">
[form-session-id]
        [button form=tform
                        extra='style="font-weight: bold"'
                        text="[L]Complete The Order[/L]"]
        mv_todo=back
        order=[cgi order]

        [email-raw][include etc/ship_notice_new][/email-raw]


        [/button]
      </div>
        </form>
[/if]
		[/if]	

[if term='[cgi bypass]' op='!=' compare='1'] 
	
<!-- Add a new shipment to the DB -->
  [query row_count=1 list=1 sql="SELECT * FROM ups_shipments WHERE code = '[cgi order]' AND ship_status = 'processing'"]

[if term='[sql-param count]' op='==' compare='0']
  
[query sql="INSERT into ups_shipments set code = '[cgi order]', ship_status = 'processing'"][/query]

[/if]
[/query]
[/if]
<!-- Find the shipment that we made above and add the items being shipped to it -->
[query  prefix=shipments list_prefix=shipmentslist list=1 sql="SELECT shipping_id FROM ups_shipments WHERE code = '[cgi order]' AND ship_status = 'processing'"][set shipping_id] [shipments-pos 0]  [/set][/query]

   [query prefix=orderline list_prefix=orderlinelist list=1 sql="SELECT * FROM orderline WHERE order_number LIKE '[cgi order]'"]
   <!-- ok-->
    [query prefix=totalshipped list_prefix=count sql="select SUM(qty) AS 'Shipped' FROM ups_shipments_items_temp WHERE code = '[orderline-code]'" type=list][seti shipped][calc ] [totalshipped-pos 0]-0 [/calc][/seti][/query]


	<!-- Search to see if the item exits in ups_shipment_lines  LINES-->
   			[query  prefix=shipmentlines  row_count=1 list=1 sql="SELECT * FROM ups_shipments_items_temp WHERE code = '[orderline-code]' AND shipping_id = '[scratch shipping_id]'"][seti lines][calc][shipmentlines-param count]-0[/calc][/seti][/query]



 [if term='[cgi [orderline-code]-shipped]]' op='!=' compare='0']
 
 <!-- create the temp items to be processed -->

[if term='[scratch lines]' op='==' compare='0']
[query sql="INSERT into ups_shipments_items_temp set order_number = '[cgi order]', sku = '[orderline-param sku]', description = '[orderline-param description]', options = '[orderline-param options]', box = '[cgi [orderline-code]-box]', code = '[orderline-code]', qty = '[cgi [orderline-code]-shipped]', shipping_id = '[scratch shipping_id]'"][/query]
[else]
[query sql="UPDATE ups_shipments_items_temp set options = '[orderline-param options]', box='[cgi [orderline-code]-box]', code = '[orderline-code]', qty = '[cgi [orderline-code]-shipped]', shipping_id = '[scratch shipping_id]' WHERE shipping_id='[scratch shipping_id]' AND code= '[orderline-code]'"][/query]
[/else]
[/if]
[/if]


[/query]



[loop list="[value-extended order]"]

	<table width="100%" border="0" cellpadding="6" cellspacing="1" class="rseparator">
      <tr>
        <td width="25%" nowrap class="block4bold">[L]User Name[/L]: &nbsp; <a href="[area href="admin/customer_view" form="customer=[loop-data transactions username]"]" title="View customer"><span class="maincontent">[loop-data transactions username]</span></a></td>
        <td width="25%" nowrap class="block4bold"> [L]Order Status[/L]: &nbsp;
          [page href="admin/order_status" form="order=[loop-code]"] <span class="alert">[display table=transactions col=status type=display key="[loop-code]"]</span> </a> [if-loop-data transactions archived == 1]
          ([L]archived[/L])
          [/if-loop-data]
          [if-loop-data transactions deleted == 1]
          ([L]deleted[/L])
          [/if-loop-data] </td>
        <td width="25%" nowrap class="block4bold"> [L]Affiliate[/L]: &nbsp;
          [if-loop-data transactions affiliate]
          [page href="admin/affiliate"
          form="affiliate=[loop-data transactions affiliate]"
          ]<span class="maincontent">[loop-data transactions affiliate]</span></A> [else] <span class="maincontent">[L]none[/L]</span> [/else]
          [/if-loop-data] </td>
        <td width="25%" nowrap class="block4bold"> [L]Order Date[/L]: &nbsp; <span class="maincontent"> [convert-date fmt="%b %e, %Y %l:%M %P"][loop-data transactions order_date][/convert-date] </span> </td>
      </tr>
    </table>
	<br>
	<table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <!-- CUSTOMER DETAILS -->
        [loop prefix=customer list="[loop-data transactions username]"]
        <td width="33%" valign="top"><table width="100%" height="160" border="0" cellpadding="6" cellspacing="1" class="rseparator">
          <tr>
            <td height="1%" class="block4"><a href="[area href='admin/customer_view' form='customer=[loop-data transactions username]']">[L]Customer Details[/L]</a></td>
          </tr>
          <tr>
            <td height="99%" valign="top" class="block4"><table width="100%" border="0" cellspacing="0" cellpadding="1">
              <tr>
                <td width="30%" class="block4bold">[L]Customer[/L]:</td>
                <td width="70%" class="maincontent"><a href="[area href='admin/customer_view' form='customer=[loop-data transactions username]']">[customer-data userdb fname] [customer-data userdb lname]</a> </td>
              </tr>
              [if-customer-data userdb company]
              <tr>
                <td class="block4bold"> [L]Company[/L]:</td>
                <td class="maincontent">[customer-data userdb company]</td>
              </tr>
              [/if-customer-data]
              [if-customer-data userdb phone_night]
              <tr>
                <td nowrap class="block4bold">[L]Home phone[/L]:</td>
                <td class="maincontent">[customer-data userdb phone_night]</td>
              </tr>
              [/if-customer-data]
              [if-customer-data userdb phone_day]
              <tr>
                <td nowrap class="block4bold"> [L]Work phone[/L]:</td>
                <td class="maincontent">[customer-data userdb phone_day]</td>
              </tr>
              [/if-customer-data]
              <tr>
                <td class="block4bold">[L]Email[/L]:</td>
                <td class="maincontent"><a href="mailto:[customer-data userdb email]">[loop-data transactions email]</a></td>
              </tr>
              <tr>
                <td nowrap class="block4bold">[L]Payment type[/L]:</td>
                <td class="maincontent">[loop-data transactions payment_method]</td>
              </tr>
              [if-loop-data transactions shipmode]
              <tr>
                <td nowrap class="block4bold">[L]Ship method[/L]:</td>
                <td class="maincontent">[loop-data transactions shipmode]</td>
              </tr>
              [/if-loop-data]
              <tr>
                <td height="15" colspan="2" class="block4bold"><img src="bg.gif" alt="." width="1" height="1"></td>
              </tr>
              [if type=file term="[either]__ORDER_DIRECTORY__[or]orders[/either]/[loop-code]"]
              <tr>
                <td align=right>&nbsp;</td>
                <td>[page href="process/[loop-code].pgp"
                  add_dot_html=0
                  form="
                  deliver_encrypted=1
                  mv_todo=return
                  mv_nextpage=@@MV_PAGE@@
                  order=[loop-code]
                  "][L]Decrypt Credit Card[/L]</a> </td>
              </tr>
              [/if]
            </table></td>
          </tr>
        </table></td>
        [/loop]
        <td width="3"><img src="bg.gif" alt="." width="3" height="1"></td>
        <!-- BILLING DETAILS -->
        <td width="33%" valign="top"><table width="100%" height="160" border="0" cellpadding="6" cellspacing="1" class="rseparator">
          <tr>
            <td height="1%" class="block4"><a href="#">[L]Billing Details[/L]</a></td>
          </tr>
          <tr>
            <td height="99%" valign="top" class="block4"> [if-loop-data transactions b_address1]
              [loop prefix=bill list="[loop-code]"]
              <table width="100%" border="0" cellspacing="0" cellpadding="1">
                  <tr>
                    <td width="30%" class="block4bold">[L]Name[/L]:</td>
                    <td width="70%" class="maincontent"><A HREF="[area
				href=__UI_BASE__/customer_view
				arg="[loop-data transactions username]"
		]"><u>[loop-data transactions b_fname] [loop-data transactions b_lname]</A> </td>
                  </tr>
                [if-bill-data transactions b_company]
                <tr>
                  <td width="30%" class="block4bold">[L]Company[/L]:</td>
                  <td width="70%" class="maincontent"> [loop-data transactions b_company] </td>
                </tr>
                [/if-bill-data]
                <tr>
                  <td valign="top" class="block4bold">[L]Address[/L]:</td>
                  <td class="maincontent"> [loop-data transactions b_address1]
                    [if-bill-data transactions b_address2] <br>
                    [loop-data transactions b_address2]
                    [/if-bill-data] </td>
                </tr>
                [if-bill-data transactions b_country =~ /^US|^CA/]
                <tr>
                  <td class="block4bold">[L]City, State, Zip[/L]:</td>
                  <td class="maincontent">[loop-data transactions b_city], [loop-data transactions b_state]  [loop-data transactions b_zip]</td>
                </tr>
                [else]
                <tr>
                  <td class="block4bold">[L]City[/L]:</td>
                  <td class="maincontent">[loop-data transactions b_city]</td>
                </tr>
                [if-bill-data transactions b_state]
                <tr>
                  <td class="block4bold">[L]State[/L]:</td>
                  <td class="maincontent">[loop-data transactions b_state]</td>
                </tr>
                [/if-bill-data]
                [if-bill-data transactions b_zip]
                <tr>
                  <td class="block4bold">[L]Postal code[/L]:</td>
                  <td class="maincontent">[loop-data transactions b_zip]</td>
                </tr>
                [/if-bill-data]
                [/else]
                [/if-bill-data]
                <tr>
                  <td class="block4bold">[L]Country[/L]:</td>
                  <td class="maincontent">[data table=country col=name key="[loop-data transactions b_country]"]</td>
                </tr>
                <tr>
                  <td height="15" colspan="2" class="block4bold"><img src="bg.gif" alt="." width="1" height="1"></td>
                </tr>
              </table>
              [/loop]
              [else] <i>[L]Same as shipping address[/L]</i> [/else]
              [/if-loop-data] </td>
          </tr>
        </table></td>
        <td width="3"><img src="bg.gif" alt="." width="3" height="1"></td>
        <!-- SHIPPING DETAILS -->
        <td width="34%" valign="top"><table width="100%" height="160" border="0" cellpadding="6" cellspacing="1" class="rseparator">
          <tr>
            <td height="1%" class="block4"><a href="#">[L]Shipping Details[/L]</a></td>
          </tr>
          <tr>
            <td height="99%" valign="top" class="block4"><table width="100%" border="0" cellspacing="0" cellpadding="1">
              <tr>
                <td width="30%" class="block4bold">[L]Name[/L]:</td>
                <td width="70%" class="maincontent"><A HREF="[area
				href=__UI_BASE__/customer_view
				arg="[loop-data transactions username]"
		]"><u>[loop-data transactions fname] [loop-data transactions lname]</A> </td>
              </tr>
              [if-loop-data transactions company]
              <tr>
                <td width="30%" class="block4bold">[L]Company[/L]:</td>
                <td width="70%" class="maincontent"> [loop-data transactions company] </td>
              </tr>
              [/if-loop-data]
              <tr>
                <td valign="top" class="block4bold">[L]Address[/L]:</td>
                <td class="maincontent"> [loop-data transactions address1]
                  [if-loop-data transactions address2] <br>
                  [loop-data transactions address2]
                  [/if-loop-data] </td>
              </tr>
              [if-loop-data transactions country =~ /^US|^CA/]
              <tr>
                <td class="block4bold">[L]City, State, Zip[/L]:</td>
                <td class="maincontent">[loop-data transactions city], [loop-data transactions state]  [loop-data transactions zip]</td>
              </tr>
              [else]
              <tr>
                <td class="block4bold">[L]City[/L]:</td>
                <td class="maincontent">[loop-data transactions city]</td>
              </tr>
              [if-loop-data transactions state]
              <tr>
                <td class="block4bold">[L]State[/L]:</td>
                <td class="maincontent">[loop-data transactions state]</td>
              </tr>
              [/if-loop-data]
              [if-loop-data transactions zip]
              <tr>
                <td class="block4bold">[L]Postal code[/L]:</td>
                <td class="maincontent">[loop-data transactions zip]</td>
              </tr>
              [/if-loop-data]
              [/else]
              [/if-loop-data]
              <tr>
                <td class="block4bold">[L]Country[/L]:</td>
                <td class="maincontent">[data table=country col=name key="[loop-data transactions country]"]</td>
              </tr>
              <tr>
                <td height="15" colspan="2" class="block4bold"><img src="bg.gif" alt="." width="1" height="1"></td>
              </tr>
            </table></td>
          </tr>
        </table></td>
      </tr>
    </table>
	<div align="center"><br>
	  <div align="center">
	  [/loop]
	  <br>
      <img src="https://www.westbranchangler.com/interchange-5/en_US/ups_logo.jpg" alt="UPS" width="346" height="113" border="1"><br> 
	  <table width="100%" border="0" cellpadding="6" cellspacing="1" class="rseparator">
        <tr>
          <td height="30" valign="top" nowrap class="block4bold"><div align="center"><strong>Shipments For This Order</strong></div></td>
        </tr>
      </table>
	  <br>
</div>
				
	<table width="100%" border="0" cellspacing="1" cellpadding="0">
        <tr>
          <th scope="col"><table width="685" border="1" align="center" cellpadding="3" cellspacing="0" bordercolor="#666666">
            <tr class="rownorm">
              <th width="101" scope="col">#</th>
              <th width="115" scope="col">ShipID</th>
              <th width="137" scope="col">Date</th>
              <th width="157" scope="col"> Status</th>
              <th width="133" scope="col">Details</th>
            </tr>
            [query type=list sql="SELECT * FROM ups_shipments WHERE code = '[cgi order]'"]
            
            [list]
  <tr class="[sql-alternate 2]rowalt[else]rownorm[/else][/sql-alternate]" valign=top>
    <td><div align="center">&nbsp;[sql-increment]</div></td>
    <td><div align="center">[sql-param shipping_id] </div></td>
    <td><div align="center">&nbsp;[sql-param date_changed] </div></td>
    <td><div align="center">&nbsp;[sql-param ship_status] </div></td>
    <td><div align="center"><a href="https://www.westbranchangler.com/cgi-bin/site/admin/shipment_view.html?order=[cgi order]&amp;id=[data session id]&amp;shipping_id=[sql-param shipping_id]">more info </a></div></td>
  </tr>
            [/list]
            [/query]
          </table>
          <br></th>
        </tr>
		
</table>
    <table width="100%" border="0" cellpadding="6" cellspacing="1" class="rseparator">
      <tr>
        <td height="30" valign="top" nowrap class="block4bold"><div align="center"><strong>Please Ship Each Box Including Back Ordered </strong></div></td>
      </tr>
    </table>
    <br>
    <table width="100%" border="0" cellspacing="1" cellpadding="0">
      <tr>
        <th scope="col"><table width="685" border="1" align="center" cellpadding="3" cellspacing="0" bordercolor="#666666">
            <tr class="rownorm">
              <th width="174" scope="col">Box 1</th>
              <th width="159" scope="col">Box 2</th>
              <th width="162" scope="col">Box 3 </th>
              <th width="156" scope="col">Drop Ship </th>
            </tr>
          <tr valign=top>
            <td><div align="center">
			 [query  prefix=box1t row_count=1 list=1 sql="SELECT * FROM ups_shipments_items_temp WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'unshipped' AND box ='box101'"][seti box1listt][calc ] [box1t-pos 0]-0 [/calc][/seti][/query]
			 
			 [query  prefix=box1 row_count=1 list=1 sql="SELECT * FROM ups_shipments_items WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'shipped' AND box ='box101'"][seti box1list][calc ] [box1-pos 0]-0 [/calc][/seti][/query]
			 
			 [if term='[scratch box1list]' op='==' compare='0']
		
			 [if term='[scratch box1listt]' op='!=' compare='0']
		
			<form action="[area __UI_BASE__/order_process]">
			<input type="hidden" name="order" value="[cgi order]">
			<input type="hidden" name="id" value="[data session id]">
			<input type="hidden" name="shipping_id" value="[scratch shipping_id]">
			<input type="hidden" name="box" value="box101">
            <input type="submit" name="Submit" value="Submit">
			</form>           
		
					
			[else]
			   Not Used
			[/else]
			[/if]
		
			[else]
				Shipped
			[/else]
			[/if]	
				
			</div>
			</td>
			
       <td><div align="center">
				 [query  prefix=box2t row_count=1 list=1 sql="SELECT * FROM ups_shipments_items_temp WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'unshipped' AND box ='box102'"][seti box2listt][calc ] [box2t-pos 0]-0 [/calc][/seti][/query]
			 
			 [query  prefix=box2 row_count=1 list=1 sql="SELECT * FROM ups_shipments_items WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'shipped' AND box ='box102'"][seti box2list][calc ] [box2-pos 0]-0 [/calc][/seti][/query]
			 
			 [if term='[scratch box2list]' op='==' compare='0']
		
			 [if term='[scratch box2listt]' op='!=' compare='0']
			

			<form action="[area __UI_BASE__/order_process]">
			<input type="hidden" name="order" value="[cgi order]">
			<input type="hidden" name="id" value="[data session id]">
			<input type="hidden" name="shipping_id" value="[scratch shipping_id]">
			<input type="hidden" name="box" value="box102">
            <input type="submit" name="Submit" value="Submit">
			</form>    
			       
			
			[else]
			   Not Used
			[/else]
			[/if]
		
			[else]
				Shipped
			[/else]
			[/if]	
			</div>
			</td>
	
			                  <td><div align="center">
				 [query  prefix=box3t row_count=1 list=1 sql="SELECT * FROM ups_shipments_items_temp WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'unshipped' AND box ='box103'"][seti box3listt][calc ] [box3t-pos 0]-0 [/calc][/seti][/query]
			 
			 [query  prefix=box3 row_count=1 list=1 sql="SELECT * FROM ups_shipments_items WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'shipped' AND box ='box103'"][seti box3list][calc ] [box3-pos 0]-0 [/calc][/seti][/query]
			 
			 [if term='[scratch box3list]' op='==' compare='0']
			
			 [if term='[scratch box3listt]' op='!=' compare='0']
		


			<form action="[area __UI_BASE__/order_process]">
			<input type="hidden" name="order" value="[cgi order]">
			<input type="hidden" name="id" value="[data session id]">
			<input type="hidden" name="shipping_id" value="[scratch shipping_id]">
			<input type="hidden" name="box" value="box103">
            <input type="submit" name="Submit" value="Submit">
			</form>           
			
			
			[else]
			   Not Used
			[/else]
			[/if]
		
			[else]
				Shipped
			[/else]
			[/if]	
			</div>
			</td>
			
		       <td><div align="center">
[query  prefix=box4t row_count=1 list=1 sql="SELECT * FROM ups_shipments_items_temp WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'unshipped' AND box ='box104'"][seti box4listt][calc ] [box4t-pos 0]-0 [/calc][/seti][/query]
			 
			 [query  prefix=box4 row_count=1 list=1 sql="SELECT * FROM ups_shipments_items WHERE order_number = '[cgi order]' AND shipping_id = '[scratch shipping_id]' AND ship_status = 'shipped' AND box ='box104'"][seti box4list][calc ] [box4-pos 0]-0 [/calc][/seti][/query]
			 
			 [if term='[scratch box4list]' op='==' compare='0']
			
			 [if term='[scratch box4listt]' op='!=' compare='0']
		

			<form action="[area __UI_BASE__/order_process]">
			<input type="hidden" name="order" value="[cgi order]">
			<input type="hidden" name="id" value="[data session id]">
			<input type="hidden" name="shipping_id" value="[scratch shipping_id]">
			<input type="hidden" name="box" value="box104">
            <input type="submit" name="Submit" value="Submit">
			</form>           
			
		
			[else]
			   Not Used
			[/else]
			[/if]
		
			[else]
				Shipped
			[/else]
			[/if]		
				
			</div>
			</td>
          </tr>
       
        </table>
		
		Shipped=[scratch shippedtodate] Ordered=[scratch ordered]
			 [scratchd shippedtodate] [scratchd ordered]
		
		</th>
      </tr>
    </table>
	<!-- ----- END REAL STUFF ----- -->
@_UI_STD_FOOTER_@ 

