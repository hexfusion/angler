 @_UI_STD_HEAD_@



[ups-ship to_company_name="[cgi company]" to_name="[cgi name]" to_address_1="[cgi address_1]" to_address_2="[cgi address_2]" to_address_3="[cgi address_3]" to_city="[cgi city]" to_state="[cgi state]" to_zip="[cgi zip]" to_email="[cgi email]" to_phone="[cgi phone]" pk_service="[cgi shipping_service]" pk_invoice="[cgi order]" pk_weight="[cgi package_weight]" pk_length="[cgi package_length]" pk_width="[cgi package_width]" pk_height="[cgi package_height]" pk_box="[cgi box]" pk_shipping_id="[cgi shipping_id]"]



[query list=1 sql="SELECT res_tracking_number FROM ups_shipments_boxs WHERE shipping_id='[cgi shipping_id]' AND box='[cgi box]'"]
[set tracking][sql-param res_tracking_number][/set]
[/query] 
[scratch tracking]

[print-ups tracking="[scratch tracking]"]

<!--- Begin the query mess -->


[query  row_count=1 prefix=check list=1 sql="SELECT * FROM ups_shipments_boxs WHERE shipping_id='[cgi shipping_id]' AND box='[cgi box]'"][seti checked][calc][check-param count]-0[/calc][/seti][/query]

[if term='[scratch checked]' op='==' compare='1']

[query  prefix=temp list=1 sql="SELECT * FROM ups_shipments_items_temp WHERE box = '[cgi box]' AND shipping_id = '[cgi shipping_id]' and order_number = '[cgi order]'"]

[query  row_count=1 prefix=check2 list=1 sql="SELECT * FROM ups_shipments_items WHERE shipping_id='[cgi shipping_id]' AND box='[cgi box]' AND code='[temp-param code]'"][seti checked2][calc][check2-param count]-0[/calc][/seti][/query]

[if term='[scratch checked2]' op='==' compare='0']
[query  prefix=orderline list=1 sql="SELECT quantity FROM orderline WHERE code = '[temp-param code]'"][seti orderqty][orderline-param quantity][/seti][/query]

[query prefix=totalshipped list_prefix=count sql="select SUM(qty) AS 'Shipped' FROM ups_shipments_items WHERE code = '[temp-code]'" type=list][seti shipped][calc ] [totalshipped-pos 0]-0 [/calc][/seti][/query]


	<!-- Search to see if the item exits in ups_shipment_lines  LINES-->
[query  prefix=shipmentlines  row_count=1 list=1 sql="SELECT * FROM ups_shipments_items WHERE code = '[orderline-code]' AND shipping_id = '[cgi shipping_id]'"][seti lines][calc][shipmentlines-param count]-0[/calc][/seti][/query]


 [if term='[calc]([scratch shipped]+[temp-param qty])[calc]' op='<' compare='[calc interpolate = "1"]([scratch orderqty] - [scratch shipped])[/calc]']


[query sql="UPDATE orderline set status = 'partial' WHERE code='[temp-param code]'"][/query]

[query sql="UPDATE transactions set status = 'partial' WHERE code='[temp-param code]'"][/query]

[if term='[scratch lines]' op='==' compare='0']

[query sql="INSERT into ups_shipments_items set res_tracking_number = '[scratch tracking]', order_number = '[temp-param order_number]', sku = '[temp-param sku]', description = '[temp-param description]', options = '[temp-param options]', box = '[temp-param box]', code = '[temp-param code]', qty = '[temp-param qty]', shipping_id = '[temp-param shipping_id]', ship_status = 'shipped'"][/query]
[else]
[query sql="UPDATE ups_shipments_items set options = res_tracking_number, '[scratch tracking]', '[temp-param options]', box='[temp-param box]', code = '[orderline-code]', qty = '[cgi [orderline-code]-shipped]', shipping_id = '[scratch shipping_id]' WHERE shipping_id='[scratch shipping_id]' AND code= '[temp-param shipping_id]'"][/query]
[/else]
[/if]
[/if]


[if term='[calc]([scratch shipped]+[temp-param qty])[calc]' op='==' compare='[calc interpolate = "1"]([scratch orderqty] - [scratch shipped])[/calc]'] 


[query sql="UPDATE orderline set status = 'shipped' WHERE code='[temp-param code]'"][/query]

[if term='[scratch lines]' op='==' compare='0']

[query sql="INSERT into ups_shipments_items set order_number = '[temp-param order]', sku = '[temp-param sku]', description = '[temp-param description]', options = '[temp-param options]', box = '[temp-param box]', code = '[temp-param code]', qty = '[temp-param code]', shipping_id = '[temp-param shipping_id]', ship_status = 'shipped'"][/query]
[else]
[query sql="UPDATE ups_shipments_items set options = '[temp-param options]', box='[temp-param box]', code = '[orderline-code]', qty = '[cgi [orderline-code]-shipped]', shipping_id = '[scratch shipping_id]' WHERE shipping_id='[scratch shipping_id]' AND code= '[temp-param shipping_id]'"][/query]
[/else]
[/if]
[/if]

[/if]
[query list=1 sql="DELETE FROM ups_shipments_items_temp WHERE code='[temp-param code]'"][/query]
[/query]
[else]
UPS Script Not Working Try Again
[/else]
[/if]


[output name=bottom_buttons]
<form action="[area __UI_BASE__/order_ship]">
<input type="hidden" name="order" value="[cgi order]">
<input type="hidden" name="bypass" value="1">
<input type="hidden" name="id" value="[data session id]">
<input type="hidden" name="shipping_id" value="[cgi shipping_id]">
<span class="hiddenOnPrint">
  <input name="submit" type="submit" value="Next Shipment">
  </span>
</p>
</form>

[output]
  
    
<!-- ----- END REAL STUFF ----- -->
@_UI_STD_FOOTER_@
