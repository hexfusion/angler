#! /usr/bin/env perl

use strict;
use warnings;

use Dancer ':script';
use Dancer::Plugin::Interchange6;

set logger        => 'console';
set logger_format => '%m';

use Locale::SubCountry;
use DateTime qw();

my $now    = DateTime->now;
my $schema = shop_schema;
my $data;
my %product;

shop_schema->deploy({add_drop_table => 1});

my $state = $schema->resultset("State")->find( { country_iso_code => 'US', state_iso_code => 'NY' });
my $state_oregon = $schema->resultset("State")->find( { country_iso_code => 'US', state_iso_code => 'OR' });

# roles
my $roles = $schema->resultset("Role")->populate([
    { roles_id => '4', name => 'user', label => 'User' },
    { roles_id => '5', name => 'editor', label => 'Editor' },
    { roles_id => '6', name => 'pro', label => 'Industry Pro' },
    { roles_id => '7', name => 'staff', label => 'Shop Staff' },
  ]);

my %users;

# Create user john
$users{john} = shop_user->create(
    { username => 'john', password => 'john', first_name => 'John',
      last_name => 'Miller', email => 'sam@westbranchresort.com',
      created => $now,
      user_roles => [
          { roles_id => '4' },
          { roles_id => '6' },
      ],
  });

shop_address->create({
    users_id => $users{john}->id,
    first_name => $users{john}->first_name,
    last_name => $users{john}->last_name,
    type => 'shipping',
    address => 'Test Road',
    postal_code => '13783',
    city => 'Hancock',
    states_id => $state->id,
    country_iso_code => 'US',
});

# Create user ben
$users{ben} = shop_user->create(
    { username => 'ben', password => 'ben', first_name => 'Ben',
      last_name => 'Sheard', email => 'sam@westbranchresort.com',
      created => $now,
      user_roles => [
          { roles_id => '4' },
          { roles_id => '7' },
      ],
  });

# Create user greg
$users{greg} = shop_user->create(
    { username => 'gregory', password => 'gregory', nickname => 'pike lover',
      first_name => 'Gregor', last_name => 'Fisherman',
      email => 'greg@perl.dance', created => $now,
      user_roles => [
        { roles_id => '4' },
      ],
  });

shop_address->create({
    users_id => $users{greg}->id,
    first_name => $users{greg}->first_name,
    last_name => $users{greg}->last_name,
    type => 'shipping',
    address => 'Crescent Ave',
    postal_code => '97403',
    city => 'Eugene',
    states_id => $state_oregon->id,
    country_iso_code => 'US',
});

# Create user sam
$users{sam} = shop_user->create(
    { username => 'sam', password => 'sam', nickname => 'trout lover',
      first_name => 'Sam', last_name => 'Batschelet',
      email => 'sbatschelet@mac.com', created => $now,
      user_roles => [
        { roles_id => '1' },
        { roles_id => '4' },
        { roles_id => '7' },
      ],
  });

# navigatiom
my $nav = $schema->resultset("Navigation")->populate([
{ uri => 'Fly-Fishing-Gear', type => 'menu', description => 'Gear for fly fishing' },
{ uri => 'Clothing/Mens', type => 'menu', description => 'Clothing for fly fishing' },
{ uri => 'Fly-Tying', type => 'menu', description => 'Materials for fly tying' },
{ uri => 'Flies', type => 'menu', description => 'Flies for fishing' },
{ uri => 'Fly-Fishing-Gear/Fly-Rods', type => 'menu', scope => 'cat-gear', name => 'Fly Rods' },
{ uri => 'Fly-Fishing-Gear/Fly-Reels', type => 'menu', scope => 'cat-gear', name => 'Fly Reels' },
{ uri => 'Fly-Fishing-Gear/Fly-Line', type => 'menu', scope => 'cat-gear', name => 'Fly Line & Backing' },
{ uri => 'Fly-Fishing-Gear/Waders', type => 'menu', scope => 'cat-gear', name => 'Waders' },
{ uri => 'Fly-Fishing-Gear/Wading-Boots', type => 'menu', scope => 'cat-gear', name => 'Wading Boots' },
{ uri => 'Fly-Fishing-Gear/Fly-Boxes', type => 'menu', scope => 'cat-gear', name => 'Fly Boxes' },
{ uri => 'Fly-Fishing-Gear/Packs-Vests', type => 'menu', scope => 'cat-gear', name => 'Packs & Vests' },
{ uri => 'contact', type => 'menu', scope => 'nav-top', name => 'Contact' },
{ uri => 'about-us', type => 'menu', scope => 'nav-top', name => 'About Us' },
{ uri => 'shipping', type => 'menu', scope => 'nav-top', name => 'Shipping' },
{ uri => 'login', type => 'nav', scope => 'top-login', name => 'Login' },
{ uri => 'registration', type => 'nav', scope => 'top-login', name => 'Sign Up' },
{ uri => 'Fly-Fishing-Gear/Leader-Tippet', type => 'menu', scope => 'cat-gear-r', name => 'Leader & Tippet' },
{ uri => 'Fly-Fishing-Gear/Tools-Gadgets', type => 'menu', scope => 'cat-gear-r', name => 'Tools & Gadgets' },
{ uri => 'Fly-Fishing-Gear/Bags-Luggage', type => 'menu', scope => 'cat-gear-r', name => 'Bags & Luggage' },
{ uri => 'Fly-Fishing-Gear/Nets', type => 'menu', scope => 'cat-gear-r', name => 'Landing Nets' },
{ uri => 'Fly-Fishing-Gear/Watercraft-Boats', type => 'menu', scope => 'cat-gear-r', name => 'Watercraft & Boats' },
{ uri => 'Fly-Fishing-Gear/Books-DVDs', type => 'menu', scope => 'cat-gear-r', name => 'Books & DVDs' },
{ uri => 'Fly-Fishing-Gear/Fly-Rod-Combos', type => 'menu', scope => 'cat-gear', name => 'Fly Rod Combos' },
{ uri => 'Fly-Fishing-Gear/New', type => 'menu', scope => 'cat-gear', name => 'New Products!' },
{ uri => 'Clothing/Mens/Jackets', type => 'menu', scope => 'cat-clothing', name => 'Jackets' },
{ uri => 'Clothing/Mens/Fleece', type => 'menu', scope => 'cat-clothing', name => 'Fleece' },
{ uri => 'Clothing/Mens/Layering', type => 'menu', scope => 'cat-clothing', name => 'Layering' },
{ uri => 'Clothing/Mens/Shirts', type => 'menu', scope => 'cat-clothing', name => 'Shirts' },
{ uri => 'Clothing/Mens/T-Shirts', type => 'menu', scope => 'cat-clothing', name => 'T-Shirts' },
{ uri => 'Clothing/Mens/Pants', type => 'menu', scope => 'cat-clothing', name => 'Pants' },
{ uri => 'Clothing/Mens/Underwear', type => 'menu', scope => 'cat-clothing', name => 'Underwear' },
{ uri => 'Clothing/Mens/Hats', type => 'menu', scope => 'cat-clothing', name => 'Hats' },
{ uri => 'Clothing', type => 'menu', scope => 'cat-clothing', name => 'Clothing Men\'s' },
{ uri => 'Clothing/Mens/WBA-Logo', type => 'menu', scope => 'cat-clothing', name => 'WBA Logo Gear' },
{ uri => 'Clothing/Mens/Shorts', type => 'menu', scope => 'cat-clothing-r', name => 'Shorts' },
{ uri => 'Clothing/Mens/Socks', type => 'menu', scope => 'cat-clothing-r', name => 'Socks' },
{ uri => 'logout', type => 'nav', scope => 'top-logout', name => 'Logout' },
{ uri => 'user/account', type => 'nav', scope => 'top-logout', name => 'My Account' },
]);

# populate navigation_products array

my @navigation_products = (
['WBA0003', '5', 'item'],
);

$schema->resultset('Attribute')->create(
    {
        name             => 'rweight',
        title            => 'Choose Weight',
        type             => 'variant',
        priority         => 1,
        attribute_values => [
            { value => '00',  title => '00WT' },
            { value => '0',  title => '0WT' },
            { value => '1',  title => '1WT' },
            { value => '2',  title => '2WT' },
            { value => '3',  title => '3WT' },
            { value => '4', title => '4WT' },
            { value => '5', title => '5WT' },
            { value => '6', title => '6WT' },
            { value => '7', title => '7WT' },
            { value => '9', title => '9WT' },
            { value => '10', title => '10WT' },
        ]
    }
);

$schema->resultset('Attribute')->create(
    {
        name             => 'length',
        title            => 'Choose Length',
        type             => 'variant',
        priority         => 1,
        attribute_values => [
            { value => '6',  title => '6FT' },
            { value => '7',  title => '7FT' },
            { value => '7_6', title => '7FT 6IN' },
            { value => '7_9', title => '7FT 9IN' },
            { value => '8_4', title => '8FT 4IN' },
            { value => '8_6', title => '8FT 6IN' },
            { value => '9', title => '9FT' },
            { value => '10', title => '10FT' },
        ]
    }
);

$schema->resultset('Attribute')->create(
    {
        name             => 'action',
        title            => 'Choose Action',
        type             => 'variant',
        priority         => 1,
        attribute_values => [
            { value => 'tip',  title => 'Tip Flex' },
            { value => 'mid',  title => 'Mid Flex' },
        ]
    }
);

$schema->resultset('Attribute')->create(
    {
        name             => 'pounds',
        title            => 'Choose Pound Stength',
        type             => 'variant',
        priority         => 1,
        attribute_values => [
            { value => '12',  title => '12 lb' },
            { value => '20',  title => '20 lb' },
            { value => '30',  title => '30 lb' },
        ]
    }
);

$product{WBA0003} = $schema->resultset('Product')->create(
    {
        sku => 'WBA0003',
        name => 'Orvis Helios 2 Fly Rod',
        short_description => 'When a customer asks is the Helios 2 really better than the Helios 1.  The answer is simple just cast it.',
        description => "Helios 2 fly rods are the best fly rods we have ever produced, period. Not only are these fly rods lightweight, sensitive and extremely powerful, they have an incredible look! Made in Manchester, Vermont, Helios 2 rods are the ultimate freshwater fly rods for all anglers. The fine-tuned tapers deliver spot-on accuracy and smooth tracking. Newly designed to be lighter in hand without compromising strength and power, the Helios 2 fly rods are making fly casting easier in all conditions. Available in three or four-piece sections, the Helios 2 fly rods come in all line weights for all fly-fishing applications. A custom-finished reel seat completes the sleek look of these freshwater fly rods, allowing the rod to stand out in a crowd. Pick up the Helios 2 and make a cast and you will realize instantly why these are the best fly rods made.",
        price => '795',
        uri => 'orvis-helios-2-fly-rod',
        weight => '5',
        inventory_exempt => '1',
    }
);

$product{WBA1001} = $schema->resultset('Product')->create(
    {
        sku => 'WBA1001',
        name => 'Orvis Hydros 3D WF Trout',
        short_description => 'The finest textured fly line for trout you can put on a reel. Fully engineered with features to improve your cast and presentation for greater productivity on the stream.',
        description => "Enjoy the feel of minimal friction in your casting stroke. 3D texturing combined with IS, our most versatile trout taper, the new Hy-Flote Tip, and the new and improved welded loop, combine to offer the finest trout line we've ever offered.",
        price => '95',
        uri => 'orvis-hydros-3d-wf-trout',
        weight => '2',
        inventory_exempt => '1',
     }
);

$product{WBA2001} = $schema->resultset('Product')->create(
    {
        sku => 'WBA2001',
        name => 'Orvis Fly Line Backing',
        short_description => "Quality backing can be the differnce between landing and losing the fish of a lifetime.",
        description => "Orvis uses the finest braid to make sure you are protected from abrasion.",
        price => '7.95',
        uri => 'orvis-backing',
        weight => '1',
        inventory_exempt => '1',
    }
);

$schema->resultset('Product')->find( { sku => "WBA1001" } )->add_variants(
    {
        rweight => '3',
        sku    => 'WBA1002',
        uri    => 'orvis-hydros-3d-wf-trout-wf-3',
        price  => 95,
        weight => '5',
    },
    {
        rweight => '4',
        sku    => 'WBA1003',
        uri    => 'orvis-hydros-3d-wf-trout-wf-4',
        price  => 95,
        weight => '5',
    },
    {
        rweight => '5',
        sku    => 'WBA1004',
        uri    => 'orvis-hydros-3d-wf-trout-wf-5',
        price  => 95,
        weight => '5',
    },
    {
        rweight => '6',
        sku    => 'WBA1005',
        uri    => 'orvis-hydros-3d-wf-trout-wf-6',
        price  => 95,
        weight => '5',
    },
);

$schema->resultset('Product')->find( { sku => "WBA2001" } )->add_variants(
    {
        pounds => '12',
        sku    => 'WBA2002',
        uri    => 'orvis-backing-12lb',
        price  => '7.95',
        weight => '1',
    },
    {
        pounds => '20',
        sku    => 'WBA2003',
        uri    => 'orvis-backing-20lb',
        price  => 7.95,
        weight => '1',
    },
    {
        pounds => '30',
        sku    => 'WBA2004',
        uri    => 'orvis-backing-30lb',
        price  => '7.95',
        weight => '1',
    },
);

$schema->resultset('Product')->find( { sku => "WBA0003" } )->add_variants(
    {
        rweight => '2',
        length => '6',
        action => 'mid',
        sku    => 'WBA0001',
        uri    => 'orvis-helios-2-620-3-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '2',
        length => '8_4',
        action => 'mid',
        sku    => 'WBA0002',
        uri    => 'orvis-helios-2-842-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '3',
        length => '7_6',
        action => 'mid',
        sku    => 'WBA0004',
        uri    => 'orvis-helios-2-376-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '3',
        length => '8_4',
        action => 'mid',
        sku    => 'WBA0005',
        uri    => 'orvis-helios-2-384-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '3',
        length => '10',
        action => 'tip',
        sku    => 'WBA0006',
        uri    => 'orvis-helios-2-3100-4-tip-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '4',
        length => '7',
        action => 'mid',
        sku    => 'WBA0007',
        uri    => 'orvis-helios-2-470-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '4',
        length => '8_6',
        action => 'mid',
        sku    => 'WBA0008',
        uri    => 'orvis-helios-2-486-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '4',
        length => '9',
        action => 'mid',
        sku    => 'WBA0009',
        uri    => 'orvis-helios-2-490-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '4',
        length => '9',
        action => 'tip',
        sku    => 'WBA0010',
        uri    => 'orvis-helios-2-490-4-tip-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '4',
        length => '10',
        action => 'tip',
        sku    => 'WBA0011',
        uri    => 'orvis-helios-2-4100-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '5',
        length => '7_9',
        action => 'mid',
        sku    => 'WBA0012',
        uri    => 'orvis-helios-2-579-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '5',
        length => '8_6',
        action => 'mid',
        sku    => 'WBA0013',
        uri    => 'orvis-helios-2-586-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '5',
        length => '8_6',
        action => 'tip',
        sku    => 'WBA0014',
        uri    => 'orvis-helios-2-586-4-tip-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '5',
        length => '9',
        action => 'mid',
        sku    => 'WBA0015',
        uri    => 'orvis-helios-2-590-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '5',
        length => '9',
        action => 'tip',
        sku    => 'WBA0016',
        uri    => 'orvis-helios-2-590-4-tip-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '5',
        length => '10',
        action => 'tip',
        sku    => 'WBA0017',
        uri    => 'orvis-helios-2-5100-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '6',
        length => '9',
        action => 'mid',
        sku    => 'WBA0018',
        uri    => 'orvis-helios-2-690-4-mid-flex',
        price  => 795,
        weight => '5',
    },
    {
        rweight => '6',
        length => '9',
        action => 'tip',
        sku    => 'WBA0019',
        uri    => 'orvis-helios-2-690-4-tip-flex',
        price  => 795,
        weight => '5',
    },
);

my $merch = $schema->resultset('MerchandisingProduct')->populate([
                                           { 
                                             sku => 'WBA0003', 
                                             sku_related => 'WBA1001',
                                             type => 'related' 
                                           },
                                           {
                                             sku => 'WBA0003',
                                             sku_related => 'WBA2001',
                                             type => 'related'
                                           },
                                          ]);

my $types = $schema->resultset('MediaType')->populate([
                                           { type => 'image' },
                                           { type => 'video' },
                                           { type => 'js' },
                                           { type => 'css' },
                                          ]);


my $images = $schema->resultset('MediaType')->find({ type => 'image' });

# for now, call the type with the size
foreach my $type (qw/120x120 169x169  325x325  50x50  70x70  975x975
                     optimized_jpgs/) {
    $images->add_to_media_displays({
                                    type => 'image_' . $type,
                                    name => 'image_' . $type,
                                    path => "/images/products/$type",
                                    size => $type,});
}

# set default for example product
my $media = $schema->resultset('Media')->populate([
                            {
                                file => 'public/images/products/optimized_jpgs/orvis_helios_2.jpg',
                                uri => 'orvis_helios_2.jpg',
                                mime_type => 'image/jpg',
                                media_types_id => '1',
                            },
                            {
                                uri => 'http://www.youtube.com/embed/HfhpZPdrc2A',
                                media_types_id => '2',
                            },
]);

# add all js/css assets
$media = $schema->resultset('Media')->populate([
                            {
                                file => 'public/css/rateit.css',
                                uri => 'rateit.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/css_002.css',
                                uri => 'css_002.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/css.css',
                                uri => 'css.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/font-awesome.css',
                                uri => 'font-awesome.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/jquery.css',
                                uri => 'jquery.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/photoswipe.css',
                                uri => 'photoswipe.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/bootstrap.css',
                                uri => 'bootstrap.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/extra_style.css',
                                uri => 'extra_style.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/styles.css',
                                uri => 'styles.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/responsive.css',
                                uri => 'responsive.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/superfish.css',
                                uri => 'superfish.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/css/camera.css',
                                uri => 'camera.css',
                                mime_type => 'text/css',
                                media_types_id => '4',
                            },
                            {
                                file => 'public/js/jquery-1.js',
                                uri => 'jquery-1.js',
                                mime_type => 'text/javascript',
                                media_types_id => '3',
                            },
                            {
                                file => 'public/js/jquery-migrate-1.js',
                                uri => 'jquery-migrate-1.js',
                                mime_type => 'text/javascript',
                                media_types_id => '3',
                            },
                            {
                                file => 'public/js/jquery.rateit.min.js',
                                uri => 'jquery.rateit.min.js',
                                mime_type => 'text/javascript',
                                media_types_id => '3',
                            },
                            {
                                file => 'public/js/superfish.js',
                                uri => 'superfish.js',
                                mime_type => 'text/javascript',
                                media_types_id => '3',
                            },
                            {
                                file => 'public/js/scripts.js',
                                uri => 'scripts.js',
                                mime_type => 'text/javascript',
                                media_types_id => '3',
                            },
                            {
                                file => 'public/js/bootstrap-hover-dropdown.js',
                                uri => 'bootstrap-hover-dropdown.js',
                                mime_type => 'text/javascript',
                                media_types_id => '3',
                            },
                            {
                                file => 'public/js/fitdivs.js',
                                uri => 'fitdivs.js',
                                mime_type => 'text/javascript',
                                media_types_id => '3',
                            },
]);


$schema->resultset('MediaProduct')->populate([
                                           { media_id => '1', sku => 'WBA0001' },
                                           { media_id => '1', sku => 'WBA0002' },
                                           { media_id => '1', sku => 'WBA0003' },
                                           { media_id => '1', sku => 'WBA0004' },
                                           { media_id => '1', sku => 'WBA0005' },
                                           { media_id => '1', sku => 'WBA0006' },
                                           { media_id => '1', sku => 'WBA0007' },
                                           { media_id => '2', sku => 'WBA0001' },
                                           { media_id => '2', sku => 'WBA0002' },
                                           { media_id => '2', sku => 'WBA0003' },
                                           { media_id => '2', sku => 'WBA0004' },
                                           { media_id => '2', sku => 'WBA0005' },
                                           { media_id => '2', sku => 'WBA0006' },
                                           { media_id => '2', sku => 'WBA0007' },
                                          ]);

$product{WBA0003}->add_to_reviews(
                    {
                    title           => '1',
                    message_types_id   => '3',
                    content         => "The Helios 2 fly rod changed my life I can't say enough good things about it.",
                    author_users_id          =>  $users{john}->id,
                    rating          => '5.0',
                    recommend       => '1',
                    public          => '1',
                    approved        => '1',
                    approved_by_users_id     => $users{sam}->id,
                 },
);

$schema->resultset('Product')->find( { sku => "WBA0017" } )->add_to_reviews(
                                    {
                                        title           => '1',
                                        message_types_id   => '3',
                                        content         => "It's a fine rod but to me it's way over priced.",
                                        author_users_id          =>  $users{ben}->id,
                                        rating          => '3.5',
                                        recommend       => '1',
                                        public          => '1',
                                        approved        => '1',
                                        approved_by_users_id     => $users{sam}->id,
                                    },
);

