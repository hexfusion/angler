[comment]
ui_component: results_grid
ui_type: component
ui_name: results_grid
ui_class: content
ui_group: search
ui_help: Configurable results page with Buy List.
ui_label: Search Results (configurable grid) with Buy List
ui_source: templates/components/results_grid

cols:
	help: You can control the number of rows by using an appropriate number for mv_matchlimit in the search
	label: <a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acols&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=15156" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acols&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14906" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acols&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14718" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acols&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34516" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acols&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34220" title="Edit meta" style="float: right">meta</a>Number of Columns to display?
	options: 1,2,3*,4,5,6,7,8,9,10
	type: select

columnize:
	help: Set to Yes when you want your results vertically organized.
	label: <a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acolumnize&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=15157" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acolumnize&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14907" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acolumnize&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14719" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acolumnize&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34517" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3acolumnize&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34221" title="Edit meta" style="float: right">meta</a>Use Newspaper format?
	type: yesno

htmltmpl:
	help: Define your own HTML template using {FIELDNAME} constructs as placeholders for the (record)fields. E.g. {SKU} for the SKU and {DESCRIPTION} for the description of a product. This will override the default template.
	label: <a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3ahtmltmpl&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=15158" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3ahtmltmpl&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14908" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3ahtmltmpl&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14720" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3ahtmltmpl&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34518" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3ahtmltmpl&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34222" title="Edit meta" style="float: right">meta</a>Template
	type: textarea_10_50

buylist_button:
	help: Only useful in combination with a Quantity box placeholder( {QUANTITY_BOX} ) in template.
	label: <a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3abuylist_button&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=15159" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3abuylist_button&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14909" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3abuylist_button&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14721" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3abuylist_button&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34519" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3abuylist_button&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34223" title="Edit meta" style="float: right">meta</a>Display Buy List Button?
	type: yesno

output:
	help: Which section of the page the component should go to
	label: <a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3aoutput&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=15160" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3aoutput&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14910" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3aoutput&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=hp6FyPMX&mv_pc=14722" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3aoutput&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34520" title="Edit meta" style="float: right">meta</a><a href="https://secure.westbranchresort.com/cgi-bin/site/admin/meta_editor.html?item_id=standard_page_editor%3a%3aui_component%3a%3aoutput&ui_return_to=admin%2fcontent_editor&ui_return_to=ui_name=results_grid&id=7IsahW28&mv_pc=34224" title="Edit meta" style="float: right">meta</a>Output location
	passed: =default,\
							left=Left,\
							right=Right,\
							top=Top,\
							Bottom=Bottom
	type: select

[/comment]
<!-- BEGIN COMPONENT [control component results_grid] -->


[comment]
Available placeholders for HTML Template:
* All field names (in capitals) e.g. {SKU} for sku field, {COMMENT} for comment field, etc.
* Additional place holders:
	{PRICE}		- processed product field
	{IMAGE}		- processed product field, full image tag (item image)
	{THUMB}		- processed product field, full image tag (thumb image)
    {SALE}		- if item has sale_price shows sale
	{STOCK}		- Inventory check, returns text 'Yes' or link 'No' to function/stock_alert page
	{PRODUCT_LINK}	- Represents the URL to products page. To be used in href 
	{QUANTITY_BOX}	- Text input box to specify the quantity of product
	{BUY_BUTTON}	- The 'BUY NOW' button

Please send any comments or suggestions for improvement to: 
	Ton Verhagen (ton@verhagen.net) 
[/comment]


[tmp buylist_button][control buylist_button 0][/tmp]
<br>

[if scratch did_order]
[include file="templates/components/cart_display"]<br>
[/if]
[set did_order][/set]

[perl tables="products"]$Scratch->{itemcount}=0;return;[/perl]
[search-region]
[seti results_return_to][history-scan exclude=nothing count=0][/seti]
[set munge_quantity]
[calc]
        $Scratch->{did_order} = 1;
        @q = split /\0/, $CGI->{mv_order_quantity};
        for (@q) {
                next unless length $_;
                $_ = "=$_";
        }
        @parms = grep /^mv_oi\d+/ && $CGI->{$_}, keys %{$CGI};

        # If we have parms, means an individual buy. If we don't
        # we want to strip empty items
        unless (@parms) {
                @i = split "\0", $CGI->{mv_order_item};
                for(my $i = 0; $i < @i; $i++) {
                        next if length($q[$i]);
                        $i[$i] = '';
                }
                @i = grep length($_), @i;
                @q = grep length($_), @q;
                $CGI_array->{mv_order_quantity} = \@q;
                $CGI->{mv_order_quantity} = join "\0", @q;
                $CGI_array->{mv_order_item} = \@i;
                $CGI->{mv_order_item} = join "\0", @i;
                return;
        }
        my $item = $parms[0];
        $item =~ /(\d+)/ or return;
        my $idx = $1;
        $idx--;
        $CGI->{mv_order_item} = $CGI->{$item};
        $CGI->{mv_order_quantity} = "$q[$idx]";
        return;
[/calc]
        [bounce href="[scratch results_return_to]"]
[/set]

[on-match]
<FORM ACTION="[area nothing]" METHOD=POST>
[form-session-id]
<INPUT TYPE=hidden NAME=mv_action VALUE=refresh>
<INPUT TYPE=hidden NAME=mv_separate_items VALUE=0>
<INPUT TYPE=hidden NAME=mv_click VALUE=munge_quantity>
[/on-match]

[calc]
    my $n = [control cols 3];
    $Scratch->{width_percent} = int(100 / $n) . '%' if $n > 0;
    return;
[/calc]

[table-organize
	embed=1
	table='width="95%" border="0" cellspacing="0" cellpadding="3"'
	cols='[control cols 3]'
	columnize='[control columnize 0]'
]
[search-list]

[item-sub show_product]

	my $sku = shift;
	my $pdb = $Db{products};
        my $record = $pdb->row_hash($sku);
        return undef unless $record;

	$Scratch->{itemcount}++;


	### Definition of default template ###
	#
my $tmpl = $Tag->control('htmltmpl') || <<EO_TMPL;
<div style="border: solid 1px #DDDDDD;" width="100%">
  <table cellpadding=2 cellspacing=0 border=0 width="100%">
     <tr class="results_description"><td colspan=2><div align="center"><b>[filter lookup.manufacturer.c_alias uc]{MANUFACTURER}[/filter]</b></div></td></tr>
     <tr class="results_description">
       <td colspan=2><div align="center"><b>{DESCRIPTION}</b></div></td>
     </tr>
     <tr>
	<td width="8%"><a href="/{SKU}.html?submenuheader=[cgi submenuheader]&catcode=[cgi catcode]">{IMAGE}</a></td>
	<td valign=top bgcolor="#eeeeee" width="92%">
		<div style="padding-left:5px;">	
			<span style="font-size:10px; color: black">
			        {SALE}<br>
				[L]SKU[/L]: {SKU}<br>
				<br>
				[L]Price[/L]: {PRICE}<br>
				[L]Stock[/L]: {STOCK}<br>
			</span>
			<p align=right><a href="/{SKU}.html?submenuheader={SUBMENUHEADER}&catcode={CATCODE}" style="text-decoration:none; font-size:10px;" title="[L]Click here for more information on this product[/L]">[L]More info...[/L]</a></p>
		</div>	</td>
    </tr>
  </table>
</div>
EO_TMPL


    $record->{submenuheader} = $CGI->{submenuheader};
    $record->{catcode} = $CGI->{catcode};
	$record->{price} = $Tag->price($sku);
	$record->{image} = $Tag->image({
					imagesubdir => "/assetstore/site/images/items/120x120/",
					src => $record->{image},
					extra => "border=0",
					title => "[L]Click for more information.[/L]",
					alt => $record->{description},
				});
	$record->{thumb} = $Tag->image({
					imagesubdir => "thumb",
					src => $record->{thumb},
					extra => "border=0",
					title => "[L]Click for more information.[/L]",
					alt => $record->{description},
				});

	my $s = $Tag->data('products','sale_price', $sku);
	if ($s > 0) {
		$record->{sale} = <<EOF;
<span style="color: #FF0000; font-size:10px; font-family: san-serif; font-weight: bold;">ON SALE</span>
EOF
	}
	else {
		$record->{sale} = <<EOF;
EOF
	}

$Tag->perl({tables => 'variants'});
	my $db = $Db{variants};
	my $qsku = $db->quote($sku);
	my $ref = $db->query("SELECT SUM(quantity) FROM variants WHERE sku=$qsku");
	my $quantity = $ref->[0]->[0];

	if ($quantity > 0) {


		$record->{stock} = <<EOF;
<span style="color: #008000; font-size:10px; font-family: san-serif; font-weight: bold;">[L]Yes[/L]</span>
EOF
	}

	else {
		my $url = $Tag->area('function/stock_alert', $sku);
		$record->{stock} = <<EOF;
<a href="$url" title="[L]Click here to pre-order this item or get notified as soon as this item is available again.[/L]" style="color: #FF0000; font-size:10px; font-family: san-serif; font-weight: bold;">[L]No[/L]</a>
EOF
	}

	$record->{product_link} = ('/$sku');
    
	$record->{buy_button} = <<EOF;
<input type=submit value="[L]BUY NOW[/L]" onClick="this.form.mv_oi$Scratch->{itemcount}.value='$sku'" class=button2>
EOF

	$record->{quantity_box} = <<EOF;
<input type=text name=mv_order_quantity size=2 value="" style="height:16px;font-size:10px;background-color:#eeeeee;">
EOF
	return $Tag->uc_attr_list($record,$tmpl);

[/item-sub]


<TD width="[scratch width_percent]">
  <INPUT TYPE=hidden  NAME="mv_order_item" VALUE="[item-code]">
  <input type=hidden name="mv_oi[item-increment]" value="">
  [item-exec show_product][item-code][/item-exec]
</TD>

[/search-list]
[/table-organize]

[on-match]
[if scratch buylist_button]<div align=right style="width:95%;"><br><INPUT TYPE=submit VALUE="[L]Buy List[/L]"></div>[/if]
</FORM>
[/on-match]


<BR CLEAR=LEFT>
[more-list]
<BLOCKQUOTE>
[msg arg.0="[matches]" arg.1="[match-count]"]Matches %s of %s found.[/msg]
<BR>[more]<BR>
</BLOCKQUOTE>
[/more-list]

[/search-region]

<br>

<!-- END COMPONENT [control component results_grid] -->
